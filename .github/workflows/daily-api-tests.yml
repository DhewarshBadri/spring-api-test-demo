name: Daily API Tests

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual triggering
    inputs:
      send_email:
        description: 'Send email report'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: Build and Test with Maven
      run: |
        mvn clean test surefire-report:report
        mkdir -p target/site/
        if [ ! -f target/site/surefire-report.html ]; then
          echo "Creating fallback report"
          echo "<html><body><h1>Test Report</h1><p>Tests executed on $(date)</p></body></html>" > target/site/surefire-report.html
        fi
      
    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          target/surefire-reports/
          target/site/
        if-no-files-found: warn
        
    - name: Find HTML Test Report
      id: find-report
      if: always()
      run: |
        REPORT_PATH=$(find target/site -name "*report.html" | head -n 1)
        if [ -z "$REPORT_PATH" ]; then
          REPORT_PATH=$(find target/surefire-reports -name "*.html" | head -n 1)
        fi
        if [ -z "$REPORT_PATH" ]; then
          echo "No HTML report found, using placeholder"
          mkdir -p target/site/
          echo "<html><body><h1>Test Report</h1><p>No detailed test report was generated. Please check the GitHub Actions logs for test results.</p></body></html>" > target/site/test-report.html
          REPORT_PATH="target/site/test-report.html"
        fi
        echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_ENV
        echo "Report path: $REPORT_PATH"
        
    - name: Send Email with Test Report
      if: always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.send_email == 'true')
      uses: dawidd6/action-send-mail@v3
      continue-on-error: true
      with:
        server_address: smtp.sendgrid.net
        server_port: 465
        username: apikey
        password: ${{ secrets.SENDGRID_API_KEY }}
        subject: "API Test Report - ${{ github.repository }} - ${{ github.workflow }}"
        body: |
          <h2>API Test Report</h2>
          <p>Repository: ${{ github.repository }}</p>
          <p>Workflow: ${{ github.workflow }}</p>
          <p>Run ID: ${{ github.run_id }}</p>
          <p>See attached HTML report for details.</p>
          <p>View the full run details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}</p>
          <p>This is an automated email sent from GitHub Actions.</p>
        to: ${{ secrets.EMAIL_RECIPIENTS }}
        from: "GitHub Actions <${{ secrets.EMAIL_SENDER }}>"
        html_body: true
        attachments: ${{ env.REPORT_PATH }}
        # Security settings
        secure: true
